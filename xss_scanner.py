import requests
from bs4 import BeautifulSoup , BeautifulStoneSoup
from urllib.parse import urljoin
import os
ttt =open('LFI_report.txt',"a")

def xss(url):
    os.chdir("report")    
    def get_forms(url):
        soup=BeautifulSoup( requests.get(url).content, "html.parser")
        return(soup.find_all("form"))
    def form_details(form):
        details={}
        #form-action
        action=form.attrs.get("action").lower()
        #for-method
        method=form.attrs.get("method","get").lower()
        inputs=[]
        for input in form.find_all("input"):
            input_name=input.attrs.get("name")
            input_type=input.attrs.get("type", "text")
            inputs.append({"type":input_type,"name":input_name})

        details["action"]=action
        details["method"]=method
        details["inputs"]=inputs
        return(details)    #all details of one single form

    def submit_form(details,url,value):
        new_url=urljoin(url,details['action'])
        inputs=details['inputs']
        data={}
        for input in inputs:
            if((input['type'] == "text") or (input['type'] == "search") ):
                input['value']=value
            input_name=input["name"]
            input_value=input.get("value")
            if(input_name and input_value):
                data[input_name]=input_value

            if(details["method"]=="post"):
                return(requests.post(new_url,data=data))
            else:
                return(requests.get(new_url,params=data))

    def xss_scanner(url):
        forms=get_forms(url)
        print(f"[+] Detected {len(forms)} forms on {url}")
        payload = "<script>alert('hi')</script>"
        vulnerable=False
        for form in forms:
            details={}
            details=form_details(form)
            content= str(((submit_form(details, url, payload)).content).replace('0xa0'.encode() , b''))
            if(payload  in content):
                ttt.write(f"[+] XSS Detected on {url}\n")
                ttt.write(f"[+] Form Details:")
                ttt.write(details)
                ttt.write('\n')
                vulnerable=True
            else: ttt.write(f"{url} :  has no XSS vulnerablity\n")
        return(vulnerable)

    print(xss_scanner(url))
    os.chdir("./..")

ttt.close